# 部署说明

## 1. 本地开发环境
- JDK：17
- Maven：使用项目自带 Wrapper（`mvnw.cmd`）
- 数据库：MySQL 8（当前使用 XAMPP MySQL，端口 `3306`）
- 可选工具：Navicat（用于查看迁移后表结构）

## 2. 后端启动（Windows PowerShell）
在 `lab-flow-report-system` 目录执行：

```powershell
$env:DB_URL="jdbc:mysql://127.0.0.1:3306/lab_flow_report?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=utf8&createDatabaseIfNotExist=true"
$env:DB_USER="root"
$env:DB_PASS=""
$env:JWT_SECRET="LabFlowReportJwtSecretKeyForDevOnlyPleaseChangeInProd1234567890"
$env:JWT_EXPIRE_MINUTES="120"
$env:ATT_SECRET="LabFlowAttendanceSecretKeyForDevOnlyPleaseChangeInProd"
$env:ATT_TOKEN_TTL_SECONDS="6"
.\mvnw.cmd spring-boot:run
```

说明：
- 若不设置环境变量，系统会使用 `application.yaml` 内置开发默认值。
- 数据库 `lab_flow_report` 不存在时会自动创建（URL 含 `createDatabaseIfNotExist=true`）。
- 启动后 Flyway 会自动执行 `V1~V3` 迁移脚本。
- 二维码签到 token：
  - `ATT_SECRET` 建议与 `JWT_SECRET` 分开设置（不设置会回退用 `JWT_SECRET`）。
  - `ATT_TOKEN_TTL_SECONDS` 默认 `6` 秒（配合前端 5 秒刷新，留 1 秒容错）。

## 3. 验证步骤
- 健康检查：`GET http://localhost:8080/actuator/health`
- Swagger：`http://localhost:8080/swagger-ui/index.html`
- 登录：`POST http://localhost:8080/api/auth/login`
  - 账号：`teacher / teacher123`
  - 账号：`student / student123`
  - 账号：`admin / admin123`

## 4. 测试命令
```powershell
.\mvnw.cmd -U clean test
```

说明：
- 测试默认使用 H2 内存库（`src/test/resources/application.yaml`），不依赖本机 MySQL。
- 生产/开发运行使用 MySQL（由环境变量控制）。

## 5. 前端启动（Vite 开发服务器）
在工程根目录的 `frontend/` 下执行：

```powershell
cd C:\Users\benso\Documents\毕设\frontend
npm.cmd install
npm.cmd run dev
```

打开：
- `http://localhost:5173`

说明：
- 前端默认调用后端 `http://localhost:8080`（跨域由后端 CORS 放行：`http://localhost:5173`）。
- 登录后按角色跳转：
  - `admin` -> `/admin`
  - `teacher` -> `/teacher`
  - `student` -> `/student`
- 手机扫码说明：
  - 教师端“课表/签到”里会显示二维码与签到链接。
  - **手机不能访问 `localhost`**，需要把二维码链接的基址改成电脑局域网 IP（教师端页面有输入框可直接改）。
  - 可选：在前端启动时设置 `VITE_MOBILE_BASE_URL`（例如 `http://192.168.1.10:5173`）作为默认手机访问地址。
