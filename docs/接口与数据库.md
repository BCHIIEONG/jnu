# 接口与数据库

## 1. 当前实现范围（截至 2026-02-24）
- BOOT-001：统一返回、全局异常、traceId、Swagger、Actuator health。
- DB-001：Flyway 建表与种子数据。
- AUTH-001：登录、获取当前用户、JWT 鉴权、RBAC 角色控制。
- M2 报告主链（后端）：任务创建、报告提交/版本、批阅、反馈、成绩导出 CSV。
- ADMIN-001 管理员端：用户管理（导入/CRUD/重置密码/分配角色）、院系班级、实验室信息、设备台账、学期设置、操作审计日志、各模块 CSV 导出。
- SCHED-001：节次与课表（管理员维护；教师周课表查看）。
- ATT-001：动态二维码签到 v1（教师开启/结束；学生扫码登录签到；实时名单/补签/导出）。

## 2. 统一返回结构
- 字段：`code`、`message`、`data`、`traceId`、`timestamp`
- 成功示例：
```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "message": "pong"
  },
  "traceId": "98cb1b5076ea430a9067ce2f09bb8975",
  "timestamp": "2026-02-10T07:05:09.468053500Z"
}
```

## 3. 错误码
- `0`：成功
- `40000`：请求参数错误或资源不存在
- `40001`：参数校验失败
- `40100`：未登录或登录失效
- `40300`：无权限
- `50000`：服务器内部错误

## 4. 数据库表（Flyway）
### 4.1 RBAC
- `sys_user`
  - `id` PK
  - `username` 唯一
  - `password_hash` BCrypt
  - `display_name`
  - `enabled`
  - `department_id`（可选，外键 -> `org_department.id`）
  - `class_id`（可选，外键 -> `org_class.id`）
  - `created_at` `updated_at`
- `sys_role`
  - `id` PK
  - `code` 唯一（`ROLE_ADMIN` / `ROLE_TEACHER` / `ROLE_STUDENT`）
  - `name`
  - `created_at` `updated_at`
- `sys_user_role`
  - 复合主键：`(user_id, role_id)`
  - 外键：`user_id -> sys_user.id`，`role_id -> sys_role.id`

### 4.2 任务与报告
- `exp_task`
  - `id` PK
  - `title`、`description`
  - `publisher_id`（教师）
  - `deadline_at`
  - `status`
  - `created_at` `updated_at`
- `report_submission`
  - `id` PK
  - `task_id`、`student_id`
  - `version_no`
  - `content_md`
  - `submit_status`
  - `submitted_at` `created_at`
  - 唯一索引：`(task_id, student_id, version_no)`
- `report_attachment`
  - `id` PK
  - `submission_id`
  - `file_name` `file_path` `file_size` `content_type`
  - `uploaded_at`
- `report_review`
  - `id` PK
  - `submission_id` 唯一
  - `teacher_id`
  - `score` `comment`
  - `reviewed_at` `updated_at`
- `export_record`
  - `id` PK
  - `operator_id`
  - `export_type`
  - `condition_json`
  - `created_at`

### 4.3 管理端基础数据与审计（V4/V5）
- `org_department`
  - 院系基础信息（名称唯一）
- `org_class`
  - 班级基础信息（同一院系下名称唯一）
  - 外键：`department_id -> org_department.id`
- `lab_room`
  - 实验室信息（名称唯一；地点/开放时间）
- `device`
  - 设备台账（编码唯一；状态/位置/描述）
- `semester`
  - 学期设置（名称唯一；起止日期可选）
- `audit_log`
  - 关键操作审计（管理员写操作必记）
  - 外键：`actor_id -> sys_user.id`

### 4.4 课表与签到（V6/V7/V8）
- `time_slot`
  - 节次（例如“第1-2节”）
  - `code` 唯一，`start_time`/`end_time` 表示时间段
- `course_schedule`
  - 课表项（学期 + 日期 + 节次 -> 班级/教师/实验室）
  - 约束：同一学期下，教师/班级在同一天同一节次不可重复（唯一索引）
- `attendance_session`
  - 签到场次（通常由某个课表项开启）
  - `status`：`OPEN`/`CLOSED`
- `attendance_record`
  - 签到记录（场次 + 学生 唯一，防重复签到）
  - `method`：`QR`/`MANUAL`

### 4.3 种子账号（V3）
- `admin / admin123`（管理员）
- `teacher / teacher123`（教师）
- `student / student123`（学生）

## 5. 接口清单
### 5.1 工程底座
- `GET /api/ping`
- `POST /api/ping/echo`
- `GET /actuator/health`
- `GET /swagger-ui/index.html`
- `GET /v3/api-docs`

### 5.2 认证与用户
- `POST /api/auth/login`
  - 入参：`username`、`password`
  - 返回：`token`、`tokenType`、`expiresAt`、`user`
- `GET /api/auth/me`
  - 需登录，返回当前用户与角色
- `POST /api/auth/logout`
  - 需登录（无状态登出占位）

### 5.3 任务与报告主链
- `POST /api/tasks`（教师/管理员）
- `GET /api/tasks`（已登录）
- `GET /api/tasks/{taskId}`（已登录）
- `POST /api/tasks/{taskId}/submissions`（学生）
- `GET /api/tasks/{taskId}/submissions/me`（学生）
- `GET /api/tasks/{taskId}/submissions`（教师/管理员）
- `POST /api/submissions/{submissionId}/review`（教师/管理员）
- `GET /api/submissions/{submissionId}/review`（教师/管理员/该提交学生）
- `GET /api/tasks/{taskId}/scores/export`（教师/管理员，CSV）
- 报告文本与附件
  - `GET /api/submissions/{submissionId}/content/download`（下载 Markdown，UTF-8 BOM）
  - `POST /api/submissions/{submissionId}/attachments`（学生上传）
  - `GET /api/submissions/{submissionId}/attachments`（授权查看列表）
  - `GET /api/attachments/{attachmentId}/download`（授权下载）

### 5.4 课表与签到（SCHED-001 / ATT-001）
- 教师（`/api/teacher/**`）
  - `GET /api/teacher/semesters`（教师可见学期列表）
  - `GET /api/teacher/time-slots`（节次列表）
  - `GET /api/teacher/schedule/week`（入参：`semesterId`、`weekStartDate`）
  - `GET /api/teacher/classes/{classId}/roster`（班级名册）
- 管理员（`/api/admin/**`）
  - `GET/POST/PUT/DELETE /api/admin/time-slots`
  - `GET/POST/PUT/DELETE /api/admin/course-schedules`（支持 semesterId/from/to/teacherId/classId）
- 签到（`/api/attendance/**`）
  - `POST /api/attendance/sessions`（教师开启签到）
  - `POST /api/attendance/sessions/{sessionId}/close`（结束）
  - `GET /api/attendance/sessions/{sessionId}/token`（动态 token）
  - `POST /api/attendance/checkin`（学生签到）
  - `GET /api/attendance/sessions/{sessionId}/records`（实时名单）
  - `POST /api/attendance/sessions/{sessionId}/manual-checkin`（教师补签）
  - `GET /api/attendance/sessions/{sessionId}/export`（CSV）

### 5.5 管理员端（/api/admin/**，仅管理员）
- 用户管理
  - `GET /api/admin/users`（支持 q/roleCode/enabled/departmentId/classId/page/size）
  - `POST /api/admin/users`
  - `PUT /api/admin/users/{id}`
  - `POST /api/admin/users/{id}/reset-password`
  - `PUT /api/admin/users/{id}/roles`
  - `POST /api/admin/users/import`（multipart csv）
  - `GET /api/admin/users/export`（CSV）
- 角色（只读）
  - `GET /api/admin/roles`
- 院系班级
  - `GET/POST/PUT/DELETE /api/admin/departments`
  - `GET/POST/PUT/DELETE /api/admin/classes`
  - `GET /api/admin/departments/export`（CSV）
  - `GET /api/admin/classes/export`（CSV）
- 实验室信息
  - `GET/POST/PUT/DELETE /api/admin/lab-rooms`
  - `GET /api/admin/lab-rooms/export`（CSV）
- 设备台账
  - `GET/POST/PUT/DELETE /api/admin/devices`
  - `GET /api/admin/devices/export`（CSV）
- 学期设置
  - `GET/POST/PUT/DELETE /api/admin/semesters`
  - `GET /api/admin/semesters/export`（CSV）
- 操作日志（审计）
  - `GET /api/admin/audit-logs`（支持 action/actorUsername/targetType/from/to/page/size）
  - `GET /api/admin/audit-logs/export`（CSV）

## 6. 认证与权限说明
- Token：`Authorization: Bearer <jwt>`
- 白名单：
  - `/api/auth/login`
  - `/api/ping/**`
  - `/actuator/health/**`
  - `/swagger-ui/**`
  - `/v3/api-docs/**`
- 其他接口默认要求登录。
