# 接口与数据库

## 1. 当前实现范围（截至 2026-02-10）
- BOOT-001：统一返回、全局异常、traceId、Swagger、Actuator health。
- DB-001：Flyway 建表与种子数据。
- AUTH-001：登录、获取当前用户、JWT 鉴权、RBAC 角色控制。
- M2 报告主链（后端）：任务创建、报告提交/版本、批阅、反馈、成绩导出 CSV。

## 2. 统一返回结构
- 字段：`code`、`message`、`data`、`traceId`、`timestamp`
- 成功示例：
```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "message": "pong"
  },
  "traceId": "98cb1b5076ea430a9067ce2f09bb8975",
  "timestamp": "2026-02-10T07:05:09.468053500Z"
}
```

## 3. 错误码
- `0`：成功
- `40000`：请求参数错误或资源不存在
- `40001`：参数校验失败
- `40100`：未登录或登录失效
- `40300`：无权限
- `50000`：服务器内部错误

## 4. 数据库表（Flyway）
### 4.1 RBAC
- `sys_user`
  - `id` PK
  - `username` 唯一
  - `password_hash` BCrypt
  - `display_name`
  - `enabled`
  - `created_at` `updated_at`
- `sys_role`
  - `id` PK
  - `code` 唯一（`ROLE_ADMIN` / `ROLE_TEACHER` / `ROLE_STUDENT`）
  - `name`
  - `created_at` `updated_at`
- `sys_user_role`
  - 复合主键：`(user_id, role_id)`
  - 外键：`user_id -> sys_user.id`，`role_id -> sys_role.id`

### 4.2 任务与报告
- `exp_task`
  - `id` PK
  - `title`、`description`
  - `publisher_id`（教师）
  - `deadline_at`
  - `status`
  - `created_at` `updated_at`
- `report_submission`
  - `id` PK
  - `task_id`、`student_id`
  - `version_no`
  - `content_md`
  - `submit_status`
  - `submitted_at` `created_at`
  - 唯一索引：`(task_id, student_id, version_no)`
- `report_attachment`
  - `id` PK
  - `submission_id`
  - `file_name` `file_path` `file_size` `content_type`
  - `uploaded_at`
- `report_review`
  - `id` PK
  - `submission_id` 唯一
  - `teacher_id`
  - `score` `comment`
  - `reviewed_at` `updated_at`
- `export_record`
  - `id` PK
  - `operator_id`
  - `export_type`
  - `condition_json`
  - `created_at`

### 4.3 种子账号（V3）
- `admin / admin123`（管理员）
- `teacher / teacher123`（教师）
- `student / student123`（学生）

## 5. 接口清单
### 5.1 工程底座
- `GET /api/ping`
- `POST /api/ping/echo`
- `GET /actuator/health`
- `GET /swagger-ui/index.html`
- `GET /v3/api-docs`

### 5.2 认证与用户
- `POST /api/auth/login`
  - 入参：`username`、`password`
  - 返回：`token`、`tokenType`、`expiresAt`、`user`
- `GET /api/auth/me`
  - 需登录，返回当前用户与角色
- `POST /api/auth/logout`
  - 需登录（无状态登出占位）

### 5.3 任务与报告主链
- `POST /api/tasks`（教师/管理员）
- `GET /api/tasks`（已登录）
- `GET /api/tasks/{taskId}`（已登录）
- `POST /api/tasks/{taskId}/submissions`（学生）
- `GET /api/tasks/{taskId}/submissions/me`（学生）
- `GET /api/tasks/{taskId}/submissions`（教师/管理员）
- `POST /api/submissions/{submissionId}/review`（教师/管理员）
- `GET /api/submissions/{submissionId}/review`（教师/管理员/该提交学生）
- `GET /api/tasks/{taskId}/scores/export`（教师/管理员，CSV）

## 6. 认证与权限说明
- Token：`Authorization: Bearer <jwt>`
- 白名单：
  - `/api/auth/login`
  - `/api/ping/**`
  - `/actuator/health/**`
  - `/swagger-ui/**`
  - `/v3/api-docs/**`
- 其他接口默认要求登录。

