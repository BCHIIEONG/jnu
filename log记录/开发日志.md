# 开发日志（Append-only）

> 可以记录进展、问题、结论；但“决策”仍以 `决策日志.md` 为准。

## 记录格式（建议）
### YYYY-MM-DD
- 今日目标：
- 实际完成：
- 遇到的问题：
- ✅定稿结论（可写入决策日志/任务单）：
- 明日计划：

---

### 2026-02-09
- 今日目标：建立文档与日志体系，让后续讨论可转 Codex 工单。
- 实际完成：确定最小文档集合与 Append-only 记录规则。
- ✅定稿结论：采用“✅定稿才入决策/任务单”的机制。
- 明日计划：输出第一批 Codex 工单：工程骨架 + RBAC + 基础库表。

### 2026-02-10 14:14:05
- 目标：初始化根目录 Git 仓库并准备 GitHub 首版上传。
- 执行：创建根目录 .gitignore（忽略 .idea、target、开题报告 docx）；开始执行 git 初始化与首提交流程。
- 结果：已完成忽略规则落地，进入 git init/add/commit 阶段。
- 下一步：初始化 main 分支并完成首提交；拿到远端 URL 后推送并回写结果。

### 2026-02-10 14:14:54
- 目标：完成首提交并准备推送 GitHub。
- 执行：git init -b main、git add .、忽略规则核验、尝试 git commit。
- 结果：commit 被阻塞（未配置 user.name / user.email）；其余步骤已完成。
- 下一步：设置本仓库提交身份后重试 commit，并绑定 origin 推送 main。

### 2026-02-10 14:24:10
- 目标：完成 GitHub 首版上传并验证验收项。
- 执行：设置仓库提交身份；完成首提交（b921f2f）；绑定 origin=https://github.com/BCHIIEONG/jnu.git；推送 main；执行状态/忽略/远端分支检查。
- 结果：首版上传成功，origin/main 已创建并跟踪；开题报告 docx 命中忽略规则且未纳入版本库。
- 下一步：按任务单进入 BOOT-001 开发；后续每次操作继续仅追加写入本日志。

### 2026-02-10 14:42:55
- 目标：清理 GitHub 中仅供 Codex 使用的说明文件。
- 执行：删除 4 个 Codex 专用文件；更新 .gitignore 增加 Codex 文件忽略规则。
- 结果：仓库已完成清理，待提交并推送到 origin/main。
- 下一步：完成 commit/push，并给出明日向老师汇报的进展与下一步开发节奏。

### 2026-02-10 14:52:56
- 目标：纠正“仅远端删除 Codex 文件”的执行偏差，并保留本地可回退备份。
- 执行：从历史提交恢复 4 个 Codex 文件到本地工作区；在 备份/2026-02-10_codex_local_only 下生成同内容副本；更新 .gitignore 忽略 备份/。
- 结果：GitHub 仍不包含 Codex 文件；本地与备份均可回退使用；后续备份目录不会再被上传。
- 下一步：进入 BOOT-001 开发，并持续按“开发日志追加”记录。

### 2026-02-10 14:57:42
- 目标：把用户新确认的长期约束固化到执行说明，防止后续遗忘。
- 执行：更新 docs/CODEX_执行说明.md，新增“用户长期约束（2026-02-10）”；同步修正定稿记录路径为 log记录/定稿记录.txt。
- 结果：本地执行说明已固化规则；后续将按“新增规则即追加写入本文件”执行。
- 下一步：继续按 BOOT-001 开发节奏推进，并保持开发日志追加记录。

### 2026-02-10 15:06:04
- 目标：完成 BOOT-001 工程底座并形成可汇报成果。
- 执行：实现统一返回/全局异常/traceId 过滤器/参数校验统一返回；新增 /api/ping 与 /api/ping/echo；配置 Swagger 与 Actuator health；补充集成测试与文档状态更新。
- 结果：执行 lab-flow-report-system\\.\\mvnw.cmd -U clean test 通过（BUILD SUCCESS，5 tests）。
- 下一步：进入 DB-001（Flyway + RBAC 最小表结构）与 AUTH-001（JWT/RBAC 骨架）。

### 2026-02-10 16:29:15
- 目标：按 M2 追赶计划完成 DB-001、AUTH-001 与报告主链后端闭环。
- 执行：新增 Flyway 迁移脚本（V1~V3）、MyBatis-Plus 持久层、JWT 鉴权与 RBAC、安全统一 401/403 返回；实现任务/提交/批阅/反馈/导出接口；补充 H2 测试配置与端到端集成测试。
- 结果：lab-flow-report-system\\.\\mvnw.cmd -U clean test 通过（Tests run: 8, Failures: 0, Errors: 0）；主链接口可联调演示。
- 下一步：如需前端演示，进入 Vue 最小页面联调；如继续后端，进入签到链与设备链。

### 2026-02-10 19:26:38
- 目标：修复 XAMPP MariaDB(MySQL 5.5) 下 Flyway V2 迁移失败导致后端无法启动的问题。
- 执行：将 V2__task_report_core.sql 中的 CLOB 字段类型改为 LONGTEXT（兼容 MariaDB/MySQL）；回归执行 mvn test。
- 结果：lab-flow-report-system\\.\\mvnw.cmd -U clean test 通过（BUILD SUCCESS）。
- 下一步：删除并重建本机库 lab_flow_report（清理失败迁移记录），再启动后端验证 Swagger 可访问。

### 2026-02-15 16:21:48
- 目标：建立“进度报告”材料归档目录，后续所有图/Word/PPT 统一存放，便于向老师汇报。
- 执行：在 C:\\Users\\benso\\Downloads\\进度报告 下创建 01_证据截图/02_用例图/03_数据库设计/04_PPT/05_演示脚本；新增 00_说明_命名与归档规则.txt 记录命名规范。
- 结果：归档目录结构已固定，可直接开始把截图、用例图、数据库说明、PPT、演示脚本按规则落盘。
- 下一步：按“CSV 中文乱码修复 -> 用例图与表说明产出”的顺序补齐汇报材料，并持续追加写入本日志。

### 2026-02-15 16:25:42
- 目标：让“进度报告”目录不只是空文件夹，提供可直接使用的模板与证据文件。
- 执行：在各子目录新增 README_*.txt 说明“放什么/怎么命名”；生成 03_数据库设计\\2026-02-15_db_tables.txt（SHOW TABLES 输出）；新增 05_演示脚本\\演示_主链路_保存CSV.ps1（跑通主链并把 CSV 保存到 01_证据截图）。
- 结果：进度报告目录已包含可用模板与数据库表清单，后续只需要补截图与用例图即可形成汇报材料包。
- 下一步：运行演示脚本生成一份“comment 中文不为 ????”的 CSV；再做 Excel 兼容（BOM）以彻底解决中文乱码。

### 2026-02-15 16:35:45
- 目标：生成可直接用于向老师汇报的“用例图 PNG + 数据库设计 Word（含表格字段解释）”材料。
- 执行：在 Downloads\\进度报告\\02_用例图 生成 5 张用例图 PNG（登录鉴权/教师发布任务/学生提交报告/教师批阅评分/导出成绩CSV）；在 Downloads\\进度报告\\03_数据库设计 生成 ER 图 PNG 与《数据库设计说明_v1.docx》（按每张表生成字段解释表格、外键与索引说明）。
- 结果：材料已落盘，可直接打开查看并用于汇报。
- 下一步：补齐 01_证据截图（health、swagger、链路调用、CSV 文件），以及针对 CSV 中文乱码做“数据源修复 + Excel(BOM)兼容”。

### 2026-02-15 16:58:11
- 目标：对当前项目状态进行总结，并输出一份“从项目到细功能+权限边界+里程碑”的完整规划报告供审查。
- 执行：根据 log记录/定稿记录.txt（范围与周计划）、PLANS.md（当前状态）、docs/（接口/部署/测试等）生成 Word 报告《项目完整规划报告_v1.docx》，输出到 Downloads\\进度报告 根目录。
- 结果：C:\\Users\\benso\\Downloads\\进度报告\\2026-02-15_项目完整规划报告_v1.docx 已生成，可直接用于老师审查与后续对照执行。
- 下一步：按报告中“模块分解与时间计划”补齐未实现模块（签到/设备/进度/查重/管理端）并同步证据截图到 01_证据截图。

### 2026-02-15 17:08:06
- 目标：解决 CSV 导出在 Excel 下常见的 UTF-8 识别问题，并提升 Swagger 联调体验（可直接输入 JWT）。
- 执行：导出接口改为返回 UTF-8 字节并在开头追加 BOM（EF BB BF）；OpenAPI 增加 Bearer JWT 安全方案以显示 Swagger 的 Authorize；更新集成测试覆盖 BOM。
- 结果：`lab-flow-report-system\\.\\mvnw.cmd -U clean test` 通过（BUILD SUCCESS，8 tests）。
- 下一步：用教师 token 实测导出 CSV 在 Excel 双击打开是否中文正常；若仍有“评语变 ????”，优先修复评语写入端（PowerShell/客户端编码）再验证导出。

### 2026-02-15 17:13:17
- 目标：提供“最终验收”逐步测试脚本，并先由 Codex 本机执行一遍验证无问题。
- 执行：新增进度报告脚本 `C:\\Users\\benso\\Downloads\\进度报告\\05_演示脚本\\测试_全套检查_逐步执行.ps1`（可选先跑 mvn test，再跑 E2E 主链路并保存 CSV，校验 UTF-8 BOM）；修正脚本对 Windows PowerShell 5.1 的 UTF-8 JSON 解码兼容（按字节流 UTF-8 解码后 ConvertFrom-Json）。
- 结果：本机执行 `测试_全套检查_逐步执行.ps1 -SkipMvn` 通过；已生成证据文件 `C:\\Users\\benso\\Downloads\\进度报告\\01_证据截图\\2026-02-15_csv_task-3.csv`，其中中文评语正常且 CSV 含 BOM。
- 下一步：你在最终验收时执行同一脚本（建议不加 -SkipMvn），并补齐 health/swagger/PowerShell 截图到 01_证据截图。

### 2026-02-23 20:56:29
- 目标：补齐“已汇报的登录+页面”真实实现，落地 FE-001 三端最小可演示前端，并完成 CORS-001 以支持浏览器联调与下载。
- 执行：
  - 后端：新增 `CorsConfig` 允许 `http://localhost:5173` 跨域访问，暴露 `X-Trace-Id`、`Content-Disposition`；保持 Security `.cors()` 生效。
  - 前端：新增 `frontend/`（Vite + Vue3 + TS + ElementPlus + Pinia + Router），实现登录页与学生/教师/管理员 3 个最小页面，并提供管理员 RBAC 自检面板；教师端支持导出成绩 CSV 下载。
  - 配置：根目录 `.gitignore` 忽略 `frontend/node_modules/`、`frontend/dist/`、`frontend/.env*`。
- 结果：
  - 后端：`lab-flow-report-system\\.\\mvnw.cmd -U clean test` 通过（BUILD SUCCESS，8 tests）。
  - 前端：`frontend\\npm.cmd run build` 通过（可启动 dev server 于 5173）。
- 下一步：更新 `docs/部署说明.md` 增加前端启动步骤；用浏览器实际验证 RBAC 页面跳转与 CSV 下载；随后进入 ATT-001 二维码签到 v1。

### 2026-02-24 03:23:18
- 目标：落地 ADMIN-001 管理员端完整功能（数据库/后端/前端/测试/证据链），满足“用户/院系班级/实验室/设备/学期/日志/导出”可演示。
- 执行：
  - 数据库：新增 Flyway `V5__admin_seed_data.sql`（院系/班级/实验室/设备/学期最小种子数据），确保 H2 与 MySQL 都可迁移至 v5。
  - 后端：新增 `/api/admin/**` 管理员接口（用户管理、角色只读、院系班级、实验室、设备、学期、审计日志、CSV 导出），并对所有写操作写入 `audit_log`；所有 CSV 导出统一加 UTF-8 BOM + `Content-Disposition`。
  - 前端：扩展 `frontend/` 的 `/admin` 为完整管理后台（Tabs：用户/院系/班级/实验室/设备/学期/操作日志/备份说明/RBAC 自检），实现导入/导出与 CRUD 操作。
  - 测试：新增 `AdminIntegrationTests` 覆盖管理员 CRUD + 越权 403 + 导出 BOM + 审计记录存在；回归 `mvn test` 全通过。
- 结果：
  - 后端：`lab-flow-report-system\\.\\mvnw.cmd -U clean test` 通过（包含新 AdminIntegrationTests）。
  - 前端：`frontend\\npm.cmd run build` 通过。
  - 文档：`docs/接口与数据库.md` 已补齐管理员端表与接口清单；`docs/CODEX_执行说明.md` 追加管理员端审计与 CSV 规则。
- 下一步：更新“进度报告”脚本与材料生成脚本（用例图/数据库说明）以覆盖管理员端，并在 `01_证据截图` 生成管理员导出 CSV 证据（Excel 打开中文不乱码）。

### 2026-02-24 03:33:27
- 目标：修复“新增班级后，编辑用户的班级下拉框不实时更新，必须刷新网页”的体验问题。
- 执行：在管理员端 `用户管理` 面板中，打开“新建用户/编辑用户”弹窗前自动重新拉取最新的角色/院系/班级列表；同时在下拉框显示加载状态，避免旧缓存导致异常。
- 结果：新增班级后无需刷新网页，回到用户管理点击编辑即可看到新班级选项；前端构建通过（`npm run build`）。
- 下一步：若还出现“内部错误”，提供后端控制台报错日志（含 traceId），我会按 traceId 定位具体接口与参数并修复。

### 2026-02-24 03:40:20
- 目标：把本轮实现同步到 GitHub，满足“继续下一任务前先推送”的规则。
- 执行：`git add -A`、提交并推送到 `origin/main`。
- 结果：已推送提交 `ea19baf98feb1c0ff137bd004c8410b9248a213d`（ADMIN-001 + 前端实时刷新修复一起入库）。
- 下一步：后续每次你说“继续下一任务/开始下一步”且未说明崩溃，我会先 push 再进入下一任务。

### 2026-02-24 13:47:36
- 目标：修复“老师端看不到学生提交文字”的问题，并补齐“学生上传附件、老师下载/预览附件、下载报告文本”的能力。
- 执行：
  - 后端：新增附件存储配置 `app.storage.dir`（默认 `uploads`，测试用 `target/test-uploads`）；新增附件接口：
    - `POST /api/submissions/{submissionId}/attachments`（学生上传）
    - `GET /api/submissions/{submissionId}/attachments`（授权后查看列表）
    - `GET /api/attachments/{attachmentId}/download`（授权后下载附件）
    - `GET /api/submissions/{submissionId}/content/download`（下载 Markdown 文本，UTF-8 BOM）
  - 前端：教师端新增“查看报告”弹窗展示 `contentMd`，支持下载文本、查看/下载/预览（图片）附件；学生端新增“附件管理”弹窗支持上传/查看/下载/预览（图片）附件。
  - 测试：扩展 `AuthAndWorkflowIntegrationTests` 覆盖附件上传/权限访问/下载与文本下载 BOM；本机 `mvn test`、前端 `npm run build` 通过。
- 结果：老师端可直接看到报告文字并可下载；学生可上传附件，老师与学生均可下载附件，图片可在线预览。
- 下一步：若需要“老师端下载整份报告包（文字+附件打包）”，再追加 ZIP 导出接口与一键下载按钮。

### 2026-02-24 20:26:27
- 目标：补齐 SCHED-001（教师周课表）与 ATT-001（动态二维码签到 v1）可演示闭环；并补充管理员删除“仅学生”用户能力。
- 执行：
  - 数据库：新增 Flyway `V6__schedule_core.sql`、`V7__attendance_core.sql`、`V8__schedule_attendance_seed_data.sql`；本机 MySQL `lab_flow_report` 已迁移到 v8。
  - 后端：新增课表与签到模块接口（管理员维护节次/课表；教师周课表/名册；教师开启签到/动态 token/实时名单/补签/导出；学生扫码登录签到）。
  - 前端：教师端新增“课表/签到”页（周表格、动态二维码、实时名单、补签、导出）；学生端新增 `/m/checkin` 扫码签到页；管理员端增加节次/课表管理面板。
  - 管理端：用户管理新增“删除（仅学生）”按钮与 `DELETE /api/admin/users/{id}`（若学生已有提交/签到记录则拒绝删除并提示禁用）。
  - 测试：`lab-flow-report-system\\.\\mvnw.cmd -U clean test` 通过；`frontend\\npm.cmd run build` 通过。
  - Git：提交并推送到 `origin/main`。
- 结果：
  - GitHub 已推送提交：
    - `a7f35a0`（SCHED-001/ATT-001：周课表 + 动态二维码签到）
    - `4dc95f1`（ADMIN：删除仅学生用户）
- 下一步：按你给的“第1-12节标准节次时间表”补齐 `time_slot` 种子数据，使周课表显示更贴近真实作息。

### 2026-02-26 00:34:05
- 目标：实现 FE-LGN-001 + LAN-001：登录回车提交；全站桌面/手机模式切换（可记住）；同 WiFi 手机可访问前端并正确连后端。
- 执行：
  - 前端：登录页支持 Enter 提交；新增“界面模式”切换（自动/桌面/手机）并持久化；新增“记住账号密码”（下次自动填充）；全站头部加入模式切换；API 默认基址改为 `http(s)://{当前主机}:8080`，解决手机访问时 `localhost` 指向错误问题；`npm run dev` 默认监听 `0.0.0.0:5173`，新增 `npm run dev:local` 只本机。
  - 后端：CORS 改为 `allowedOriginPatterns`，默认放行本机与常见局域网网段的 `5173` 来源，并支持用环境变量 `CORS_ALLOWED_ORIGIN_PATTERNS` 覆盖。
  - 测试：`frontend\\npm.cmd run build` 通过；`lab-flow-report-system\\.\\mvnw.cmd -U clean test` 通过。
- 结果：手机同 WiFi 可用 `http://<PC局域网IP>:5173` 打开前端并正常调用后端（不再因 CORS/localhost 导致失败）。
- 下一步：若要外网访问，单独规划“部署或内网穿透（cloudflared/ngrok）+ HTTPS”。

### 2026-02-26 01:00:29
- 目标：实现 MOB-UX-001：修复手机输入法触发页面缩放；学生端手机版“任务列表优先”；教师端手机版隐藏侧栏并保证课表可横向滚动。
- 执行：
  - 全局移动端：`ui=mobile` 下输入框/文本框字号强制 >= 16px（避免 iOS 自动放大）；页面高度补 `100dvh` 减少键盘弹出导致的跳动。
  - 模式切换：手机端把模式切换控件改为下拉按钮，避免 header 挤爆。
  - 学生端：手机模式改为“先列表后详情”，首页只显示实验任务列表；点任务进入任务详情页（提交报告 + 我的提交折叠面板 + 返回列表）。
  - 教师端：手机模式隐藏左侧任务栏，改为顶部选择任务；课表区域保持现有横向滚动。
  - 测试：`frontend\\npm.cmd run build` 通过。
- 结果：手机输入时不再需要手动缩放；学生端手机页面不会被侧栏挤占；教师端手机可完成核心操作。
- 下一步：按你真实作息补齐 1-12 节标准节次并优化课表显示。

### 2026-02-26 01:29:43
- 目标：修复签到二维码/链接仍指向 `localhost` 导致手机扫码打不开的问题；并把“上传附件入口”放到学生端提交报告区域（不必先去“我的提交”找附件按钮）。
- 执行：
  - 后端：新增 `GET /api/ping/lan-ips` 返回本机局域网 IPv4 列表与推荐 IP。
  - 前端（教师端）：课表/签到弹窗里 `mobileBase` 新增本地持久化与“使用推荐IP”按钮；当基址是 `localhost` 时给出明确提示，并在打开班级管理页时自动拉取局域网 IP（若用户未配置过基址则自动填充为推荐 IP）。
  - 前端（学生端）：在“提交报告”区域新增“附件（上传到最新一次提交）”上传入口与“管理/预览”按钮，复用原有附件能力。
  - 测试：`lab-flow-report-system\\.\\mvnw.cmd -U clean test` 通过；`frontend\\npm.cmd run build` 通过。
- 结果：老师端打开签到后默认会给出可被手机访问的签到链接（不再默认 `localhost`）；学生上传附件不需要切到“我的提交”。
- 下一步：如果你希望“扫码后不经过前端 5173 也能签到”（只扫 `8080`），再加一个后端 H5 页面或把前端打包到后端静态资源。

### 2026-02-26 01:46:27
- 目标：签到导出 CSV 同时包含“已签到/未签到”全名单；并补一个隐藏的管理员端 bug（创建用户时 departmentId 为空会 500）。
- 执行：
  - 后端：签到导出 `GET /api/attendance/sessions/{id}/export` 改为“班级名册全量导出”，每个学生一行，新增列 `status`（CHECKED_IN / NOT_CHECKED_IN）。
  - 后端：修复管理员 `POST /api/admin/users` 审计写入使用 `Map.of(...)` 不能包含 null 的问题（departmentId/classId 允许为空），避免 500。
- 测试：更新 `ScheduleAttendanceIntegrationTests` 覆盖未签到学生也会出现在 CSV；`lab-flow-report-system\\.\\mvnw.cmd -U clean test` 通过。
- 结果：老师导出的签到表能直接看出谁没签到；管理员创建学生账号（只填 classId 不填 departmentId）不再 500。

### 2026-02-26 01:55:48
- 目标：二维码签到支持“动态刷新秒数可配置”与“静态二维码模式”（动态仍为默认）。
- 执行：
  - 前端（教师端）：在“班级管理 / 签到”工具栏新增二维码模式选择（动态/静态）与动态刷新秒数输入；静态模式不自动刷新二维码，仍可手动点“刷新二维码”；动态模式按设置秒数自动刷新。
  - 持久化：二维码模式与秒数写入 localStorage（下次进入沿用）。
  - UI：二维码标题文案随模式/秒数变化。
  - 测试：`frontend\\npm.cmd run build` 通过。
- 结果：老师可按现场网络情况选择动态刷新频率或静态二维码；默认仍为动态 5 秒刷新。

### 2026-02-26 02:06:23
- 目标：让“静态二维码”真正可用，不再受动态 token TTL=6 秒限制；并解释“动态刷新间隔为什么不能大于 TTL”。
- 执行：
  - 数据库：新增 Flyway `V9__attendance_static_qr.sql`，给 `attendance_session` 增加 `static_code`（静态签到码）并加唯一索引。
  - 后端：新增接口
    - `GET /api/attendance/sessions/{sessionId}/static-code`（教师/管理员获取或生成静态码）
    - `POST /api/attendance/checkin/static`（学生用静态码签到）
    - 动态 token 仍走原来的 `/token` + `/checkin`，TTL=6 秒用于“旧码快速失效”。
  - 前端：教师端“静态模式”改为使用后端静态码生成二维码，二维码在签到未结束前一直有效；学生端 `/m/checkin` 支持 `?c=静态码`（静态）或 `?t=token`（动态）。
  - 测试：`lab-flow-report-system\\.\\mvnw.cmd -U clean test` 通过（覆盖静态+动态两种签到）；`frontend\\npm.cmd run build` 通过。
- 结果：需要“长一点”的场景直接切换静态二维码即可；动态二维码继续保持短 TTL 的安全性质。
